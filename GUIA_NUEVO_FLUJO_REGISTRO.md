# ğŸ“‹ GUÃA: NUEVO FLUJO DE REGISTRO DE PADRES

## ğŸ¯ FLUJO IMPLEMENTADO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   /register                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  [ğŸ”µ Continuar con Google]                            â”‚ â”‚
â”‚  â”‚  [ğŸ“± Continuar con Microsoft]                         â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  [âœ‰ï¸ Â¿Quieres hacerlo manualmente?]                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€ OpciÃ³n 1: Google/Microsoft (OAuth)
           â”‚    â”‚
           â”‚    â”œâ”€ Popup de Google/Microsoft
           â”‚    â”œâ”€ ğŸ“§ Email de confirmaciÃ³n
           â”‚    â””â”€ Click en link del email â†’ /onboarding
           â”‚
           â””â”€â”€â”€ OpciÃ³n 2: Manual
                â”‚
                â”œâ”€ Modal: Email, ContraseÃ±a, Confirmar ContraseÃ±a
                â”œâ”€ ğŸ“§ Email de confirmaciÃ³n
                â””â”€ Click en link del email â†’ /onboarding

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   /onboarding                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  âœ… Email Confirmado                                  â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  Colegio/Sede: [Selecciona tu colegio â–¼]            â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  â˜‘ Acepto TÃ©rminos y Condiciones                     â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  [Continuar â†’]                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         /onboarding (Paso 2: Agregar Estudiantes)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Agrega a tus Hijos                                   â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Estudiante 1                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Nombre: [_________________]                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Grado: [______]  SecciÃ³n: [______]              â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  [+ Agregar otro hijo]                                â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  [ğŸ‰ Finalizar y Entrar al Portal]                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  / (Portal de Padres)                        â”‚
â”‚                  Â¡Bienvenido! ğŸ‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ ARCHIVOS MODIFICADOS

### 1. **src/pages/Register.tsx**
   - âœ… RediseÃ±ado con botones sociales prominentes
   - âœ… Modal para registro manual
   - âœ… OAuth redirecciona a `/onboarding`
   - âœ… Registro manual envÃ­a email y redirecciona a `/onboarding`

### 2. **src/pages/Onboarding.tsx** (NUEVO)
   - âœ… Paso 1: Seleccionar sede y aceptar tÃ©rminos
   - âœ… Paso 2: Agregar estudiantes (nombre, grado, secciÃ³n)
   - âœ… Marca `onboarding_completed = true` al finalizar
   - âœ… Redirecciona a `/` (Portal de Padres)

### 3. **src/contexts/AuthContext.tsx**
   - âœ… `emailRedirectTo` apunta a `/onboarding` (no mÃ¡s a `/#/`)
   - âœ… Compatible con BrowserRouter

### 4. **src/App.tsx**
   - âœ… Ruta `/onboarding` ya existe y protegida con `allowedRoles={['parent']}`

### 5. **FIX_OAUTH_TRIGGER_V2.sql** (NUEVO)
   - âœ… `handle_new_user()` crea `parent_profiles` SIN `school_id`
   - âœ… `onboarding_completed = false` por defecto
   - âœ… Compatible con el nuevo flujo

---

## ğŸ“§ FLUJO DE CONFIRMACIÃ“N DE EMAIL

### Â¿CÃ³mo funciona Supabase Email Confirmation?

Cuando un usuario se registra (OAuth o manual), Supabase:

1. **Crea el usuario en `auth.users`** con `email_confirmed_at = NULL`
2. **EnvÃ­a un email de confirmaciÃ³n** con un link especial:
   ```
   https://tu-proyecto.supabase.co/auth/v1/verify?token=...&type=signup&redirect_to=/onboarding
   ```
3. **El usuario hace click en el link del email**
4. **Supabase confirma el email** y redirecciona a `/onboarding`
5. **El trigger `handle_new_user`** se ejecuta y crea `profiles` + `parent_profiles`

### âœ… ConfiguraciÃ³n en Supabase Dashboard

Para que funcione correctamente, debes configurar:

1. **Ir a Supabase Dashboard** â†’ Tu proyecto â†’ **Authentication** â†’ **URL Configuration**
2. **Site URL**: `https://parent-portal-connect.vercel.app`
3. **Redirect URLs** (agregar):
   - `https://parent-portal-connect.vercel.app/onboarding`
   - `https://parent-portal-connect.vercel.app/auth`
   - `https://parent-portal-connect.vercel.app/register`
   - `http://localhost:5173/onboarding` (para desarrollo local)

4. **Email Templates** â†’ **Confirm signup**:
   - AsegÃºrate de que el template contenga `{{ .ConfirmationURL }}`
   - El template por defecto de Supabase ya lo tiene

---

## ğŸ§ª TESTING DEL FLUJO

### OpciÃ³n 1: OAuth (Google)

1. Ir a `https://parent-portal-connect.vercel.app/register`
2. Click en **"ğŸ”µ Continuar con Google"**
3. Seleccionar cuenta de Google
4. âœ… **Supabase envÃ­a email de confirmaciÃ³n**
5. Abrir email â†’ Click en "Confirmar Email"
6. âœ… **Redirige a `/onboarding`**
7. Seleccionar sede + Aceptar tÃ©rminos â†’ **Continuar**
8. Agregar estudiantes â†’ **Finalizar y Entrar al Portal**
9. âœ… **Redirige a `/` (Portal de Padres)**

### OpciÃ³n 2: Registro Manual

1. Ir a `https://parent-portal-connect.vercel.app/register`
2. Click en **"âœ‰ï¸ Â¿Quieres hacerlo manualmente?"**
3. Ingresar email, contraseÃ±a, confirmar contraseÃ±a
4. Click en **"Crear Cuenta"**
5. âœ… **Supabase envÃ­a email de confirmaciÃ³n**
6. Abrir email â†’ Click en "Confirmar Email"
7. âœ… **Redirige a `/onboarding`**
8. (ContinÃºa igual que OAuth)

---

## ğŸ› ï¸ SCRIPTS SQL NECESARIOS

### 1. **Ejecutar el trigger actualizado**

```sql
-- En Supabase SQL Editor:
-- Copiar y pegar el contenido de FIX_OAUTH_TRIGGER_V2.sql
```

Este script:
- âœ… Crea `profiles` con `role = 'parent'`
- âœ… Crea `parent_profiles` con `onboarding_completed = false`
- âœ… NO asigna `school_id` (se asigna en onboarding)

---

## ğŸš€ PRÃ“XIMOS PASOS

### 1. Ejecutar el SQL
```bash
# En Supabase Dashboard â†’ SQL Editor
# Ejecutar: FIX_OAUTH_TRIGGER_V2.sql
```

### 2. Desplegar a Vercel
```bash
git add .
git commit -m "feat: Nuevo flujo de registro con onboarding separado"
git push origin main
```

### 3. Configurar URLs en Supabase
Ver secciÃ³n "âœ… ConfiguraciÃ³n en Supabase Dashboard"

### 4. Testear el flujo completo
- OAuth con Google
- Registro manual
- Verificar emails de confirmaciÃ³n
- Verificar redirecciones

---

## â“ PREGUNTAS FRECUENTES

### Â¿Por quÃ© el email de confirmaciÃ³n es necesario?

Supabase **siempre** envÃ­a un email de confirmaciÃ³n para verificar que el email es real y pertenece al usuario. Esto:
- âœ… Evita registros falsos
- âœ… Asegura que el usuario tiene acceso al email
- âœ… Cumple con buenas prÃ¡cticas de seguridad

### Â¿Puedo deshabilitar la confirmaciÃ³n de email?

SÃ­, pero **NO RECOMENDADO**. Para deshabilitar:

1. Supabase Dashboard â†’ **Authentication** â†’ **Settings**
2. **Email Auth** â†’ Desmarcar "Enable email confirmations"

âš ï¸ **ADVERTENCIA**: Esto permite que usuarios se registren con emails falsos.

### Â¿QuÃ© pasa si el usuario no confirma su email?

El usuario:
- âœ… EstÃ¡ creado en `auth.users`
- âŒ No puede iniciar sesiÃ³n
- âŒ `email_confirmed_at = NULL`
- ğŸ“§ Puede solicitar reenvÃ­o del email

### Â¿CÃ³mo reenviar el email de confirmaciÃ³n?

En la pÃ¡gina `/auth`, agregar un botÃ³n "Reenviar email de confirmaciÃ³n" que llame a:

```typescript
const { error } = await supabase.auth.resend({
  type: 'signup',
  email: userEmail,
});
```

---

## ğŸ“Š ESTADOS DEL USUARIO

| Estado | auth.users | profiles | parent_profiles | Puede Acceder |
|--------|-----------|----------|-----------------|---------------|
| 1. Registrado (sin confirmar) | âœ… email_confirmed_at = NULL | âŒ No existe | âŒ No existe | âŒ Nada |
| 2. Email Confirmado (sin onboarding) | âœ… Confirmado | âœ… role = parent | âœ… onboarding_completed = false | âš ï¸ Solo /onboarding |
| 3. Onboarding Completo | âœ… Confirmado | âœ… role = parent | âœ… onboarding_completed = true | âœ… Portal de Padres |

---

## âœ… CHECKLIST FINAL

- [x] `src/pages/Register.tsx` rediseÃ±ado
- [x] `src/pages/Onboarding.tsx` creado
- [x] `src/contexts/AuthContext.tsx` actualizado
- [x] `FIX_OAUTH_TRIGGER_V2.sql` creado
- [ ] SQL ejecutado en Supabase
- [ ] URLs configuradas en Supabase Dashboard
- [ ] Desplegado a Vercel
- [ ] Testeado flujo OAuth
- [ ] Testeado flujo Manual
- [ ] Verificar emails de confirmaciÃ³n

---

Â¡El nuevo flujo estÃ¡ listo para implementar! ğŸš€
